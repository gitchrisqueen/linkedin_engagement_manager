FROM python:3.13-slim AS base

ENV PYTHONFAULTHANDLER=1 \
    PYTHONHASHSEED=random \
    PYTHONUNBUFFERED=1

# Install dependencies
RUN apt-get update && apt-get install --no-install-suggests --no-install-recommends --yes \
    curl \
    unzip \
    xvfb \
    libxi6 \
    libgconf-2-4 \
    build-essential \
    # Additional dependencies
    && apt-get install -y telnet netcat-traditional \
    # cleaning up unused files
    && apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

FROM base AS builder

ENV PIP_DEFAULT_TIMEOUT=100 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_NO_CACHE_DIR=1 \
    POETRY_VERSION=1.8.4


RUN pip install "poetry==$POETRY_VERSION"
# Make sure teh export plugin is included
RUN poetry self add poetry-plugin-export

# Create a virtual environment
RUN python -m venv /.venv

# Copy the poetry.lock and pyproject.toml
COPY ../../../pyproject.toml ../../../poetry.lock ./

# Install the dependencies
RUN poetry export -f requirements.txt | /.venv/bin/pip install -r /dev/stdin

# Copy app code
#COPY src ./src
# TODO: Can we just copy the needed files and folder instead of everything
COPY ../../../src ./src
COPY ../../../README.md ./

# Copy Everythong
#COPY ../../.. .

# Install the dependencies
RUN poetry build && /.venv/bin/pip install dist/*.whl

FROM base AS final

COPY --from=builder /.venv /.venv

COPY ./compose/local/streamlit/entrypoint /entrypoint
RUN sed -i 's/\r$//g' /entrypoint
RUN chmod +x /entrypoint

COPY ./compose/local/streamlit/wait-for-it /wait-for-it
RUN sed -i 's/\r$//g' /wait-for-it
RUN chmod +x /wait-for-it

COPY ./compose/local/streamlit/start /start
RUN sed -i 's/\r$//g' /start
RUN chmod +x /start

#COPY ./compose/local/fastapi/start /fastapi-start
#RUN sed -i 's/\r$//g' /fastapi-start
#RUN chmod +x /fastapi-start

COPY ./compose/local/streamlit/celery/worker/start /start-celeryworker
RUN sed -i 's/\r$//g' /start-celeryworker
RUN chmod +x /start-celeryworker

COPY ./compose/local/streamlit/celery/beat/start /start-celerybeat
RUN sed -i 's/\r$//g' /start-celerybeat
RUN chmod +x /start-celerybeat

COPY ./compose/local/streamlit/celery/flower/start /start-flower
RUN sed -i 's/\r$//g' /start-flower
RUN chmod +x /start-flower

ENTRYPOINT ["/entrypoint"]